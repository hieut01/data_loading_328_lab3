<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8" />
  <title>Neighborhood Lakes & Parks</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }

    .side-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 380px;
      max-height: 82vh;
      background: rgba(255,255,255,0.96);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      padding: 12px;
      overflow-y: auto;
      z-index: 10;
    }

    .side-panel h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: bold;
    }

    .controls {
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .controls button {
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fafafa;
      transition: background 0.2s;
    }

    .controls button:hover {
      background: #e8e8e8;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th, td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    tr:hover {
      background: #f3f7ff;
      cursor: pointer;
    }

    .dataset-label {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      color: #fff;
      display: inline-block;
    }

    .dataset-lakes { background: #4C8BF5; }
    .dataset-parks { background: #2E8B57; }

    /* hide side panel on smaller screens */
    @media (max-width: 1024px) {
      .side-panel { display: none; }
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="side-panel" id="panel">
    <h2>Neighborhood Lakes & Parks</h2>

    <div class="controls">
      <button id="sortBtn">Sort by Area (desc)</button>
      <button id="resetView">Reset View</button>
    </div>

    <table id="featureTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Area (acres)</th>
          <th>Dataset</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGlldXRyYW4yIiwiYSI6ImNtaGVkdnNvNTBkNG0ybXExNjFobWFpMm8ifQ.csZ4K-7ctmQ5pw29u2U5Pw';

    const LAKES_FILE = 'assets/lakes.geojson';
    const PARKS_FILE = 'assets/parks.geojson';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/outdoors-v12', 
      center: [-122.33, 47.62],
      zoom: 11
    });

    let combinedFeatures = [];

    function prop(feature, key, fallback = '') {
      return feature?.properties?.[key] ?? fallback;
    }

    async function loadGeoJson(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error('Failed to load ' + url);
      return await r.json();
    }

    function fitToAllFeatures() {
      const coords = [];
      combinedFeatures.forEach(f => {
        const g = f.geometry;
        if (!g) return;
        if (g.type === 'Point') coords.push(g.coordinates);
        else if (g.type === 'Polygon') g.coordinates.flat().forEach(c => coords.push(c));
        else if (g.type === 'MultiPolygon') g.coordinates.flat(2).forEach(c => coords.push(c));
      });
      if (!coords.length) return;
      const lons = coords.map(c => c[0]);
      const lats = coords.map(c => c[1]);
      const bounds = [[Math.min(...lons), Math.min(...lats)], [Math.max(...lons), Math.max(...lats)]];
      map.fitBounds(bounds, { padding: 40 });
    }

    function populateTable() {
      const tbody = document.querySelector('#featureTable tbody');
      tbody.innerHTML = '';
      combinedFeatures.forEach((f, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.index = idx;

        tr.innerHTML = `
          <td>${f.name || '(no name)'}</td>
          <td>${f.type || ''}</td>
          <td>${f.area_acres ?? ''}</td>
          <td><span class="dataset-label ${f.dataset === 'lakes' ? 'dataset-lakes' : 'dataset-parks'}">
            ${f.dataset === 'lakes' ? 'Lakes' : 'Parks'}
          </span></td>
        `;

        tr.addEventListener('click', () => {
          const g = f.geometry;
          if (!g) return;
          let target;
          if (g.type === 'Point') target = g.coordinates;
          else if (g.type === 'Polygon') target = g.coordinates[0][0];
          else if (g.type === 'MultiPolygon') target = g.coordinates[0][0][0];
          map.flyTo({ center: target, zoom: 14 });
        });

        tbody.appendChild(tr);
      });
    }

    function sortTableByAreaDesc() {
      combinedFeatures.sort((a, b) => (parseFloat(b.area_acres) || 0) - (parseFloat(a.area_acres) || 0));
      populateTable();
    }

    document.getElementById('sortBtn').addEventListener('click', sortTableByAreaDesc);
    document.getElementById('resetView').addEventListener('click', fitToAllFeatures);

    (async function main() {
      try {
        const lakes = await loadGeoJson(LAKES_FILE);
        const parks = await loadGeoJson(PARKS_FILE);

        map.on('load', () => {
          // Lakes layer
          map.addSource('lakes', { type: 'geojson', data: lakes });
          map.addLayer({
            id: 'lakes-fill',
            type: 'fill',
            source: 'lakes',
            paint: { 'fill-color': '#4C8BF5', 'fill-opacity': 0.45 }
          });
          map.addLayer({
            id: 'lakes-outline',
            type: 'line',
            source: 'lakes',
            paint: { 'line-color': '#1f5fd6', 'line-width': 2 }
          });

          // Parks layer
          map.addSource('parks', { type: 'geojson', data: parks });
          map.addLayer({
            id: 'parks-fill',
            type: 'fill',
            source: 'parks',
            paint: { 'fill-color': '#2E8B57', 'fill-opacity': 0.35 }
          });
          map.addLayer({
            id: 'parks-outline',
            type: 'line',
            source: 'parks',
            paint: { 'line-color': '#1f6b3e', 'line-width': 2 }
          });
        });

        // Combine features
        function addFeatures(data, datasetName) {
          if (!data?.features) return;
          data.features.forEach((f, i) => {
            combinedFeatures.push({
              id: f.id || `${datasetName}-${i}`,
              name: prop(f, 'name') || prop(f, 'Name') || `(feature ${i+1})`,
              type: prop(f, 'type') || '',
              area_acres: prop(f, 'area_acres') || prop(f, 'area') || null,
              dataset: datasetName,
              geometry: f.geometry
            });
          });
        }

        addFeatures(lakes, 'lakes');
        addFeatures(parks, 'parks');

        populateTable();
        fitToAllFeatures();

        // Popup on map click
        map.on('click', e => {
          const clicked = map.queryRenderedFeatures(e.point, { layers: ['lakes-fill', 'parks-fill'] });
          if (!clicked.length) return;
          const p = clicked[0].properties || {};
          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${p.name || '(unnamed)'}</strong><br>${p.type || ''}<br>Area: ${p.area_acres || p.area || ''} acres`)
            .addTo(map);
        });

      } catch (err) {
        console.error(err);
        alert('Error loading GeoJSON files.');
      }
    })();
  </script>

</body>
</html>
